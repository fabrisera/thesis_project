```{r}
library(tidyverse)
library(lme4)
library(lmerTest)
library(stargazer)
library(performance)
library(broom)
library(broom.mixed)
```

```{r}
data = read.csv("/Users/fabrizioserafini/Desktop/senior_year/SeniorThesis/thesis_project/data/processed/cdp_total_processed_v2.csv")

data <- na.omit(data)
data
```
```{r}
# Industry is important
data$Industry = as.factor(data$Industry)
data$Industry = relevel(data$Industry, ref = "Software, Services")

data$Continent = as.factor(data$Continent)
data$Continent = relevel(data$Continent, ref = "Europe")

```

```{r}
# convert methods to a single factor column
data$Method.Ind = ifelse(data$Method.Ind.Macc == 1, "Macc", ifelse(data$Method.Ind.Budget.Efficiency == 1, "Budget Efficiency", ifelse(data$Method.Ind.Budget.Low.Carbon == 1, "Budget Low Carbon", ifelse(data$Method.Ind.Compliance == 1, "Compliance", ifelse(data$Method.Ind.Employee.Engagement == 1, "Employee Engagement", ifelse(data$Method.Ind.Financial.Opt == 1, "Financial Opt", ifelse(data$Method.Ind.Gov.Partnership == 1, "Gov Partnership", ifelse(data$Method.Ind.Internal.Finance == 1, "Internal Finance", ifelse(data$Method.Ind.Internal.Incentives == 1, "Internal Incentives", ifelse(data$Method.Ind.Internal.Price == 1, "Internal Price", ifelse(data$Method.Ind.Lower.Roi == 1, "Lower Roi", "Other")))))))))))

# merge all the other methods to Other but internal incentives adn MACC
data$Method.Ind = ifelse(data$Method.Ind == "Other", "Other", ifelse(data$Method.Ind == "Internal Incentives" | data$Method.Ind == "Macc", data$Method.Ind, "Other"))

data$Method.Ind = as.factor(data$Method.Ind)
data$Method.Ind = relevel(data$Method.Ind, ref = "Other")
# important methods are Internal Incentives, Ind MACC
# print the number of ones for each method
table(data$Method.Ind)
```



First model: predicting using year and ghg change real. We observe how on average we predict a 22% decrease in real decarbonization rate, as well as a positive and significant correlation between previous year and next year decarbonization rate. In particular, controlling for year, an increase in decarbonization rate from the previous year corresponds to 0.3 predicted next year increase in decarbonization rate. 

```{r}

model1 = lm(Ghg.Change.Real.Next ~ Year + Ghg.Change.Real, data = data)

summary(model1)
model_performance(model1)
model_performance(model1)$AIC
```


In the second model, we add our first random effect: a random intercept for the firm unique identifier code. Mixed effect models are particularly suited when we have repeated measures on the same individuals, in our case, the same firms. In particular, including an effect for each individual firm allows to take into account the correlation between each firm's timeseries without introducing an excessively high number of parameters. When adding Id as a random effect, the model's AIC decreases from 94134.242 to 94018.79, signaling a significant improvement in the model's fit. Furthermore, the signs of the coefficient yeear and ghg change real remain the same, and the coefficient for year remains significant. Adding a random effect significantly improves the model's fit, and we will therefore iterate to find the optimal combination of random effects to then identify a comprehensive set of fixed effects that best predict decarbonization rates.

```{r}
model2 = lmer(Ghg.Change.Real.Next ~ Year + Ghg.Change.Real + (1|Id), data = data)
summary(model2)
model_performance(model2)
model_performance(model2)$AIC

```

Outputting the first two tables:
```{r}
class(model1) <- "lm"
class(model2) <- "lmerMod"
tidyM1 <- broom::tidy(model1)
tidyM2 <- broom::tidy(model2) %>% filter(effect == "fixed")
 # Number of unique regions for that one random effect
num_Id <- as.numeric(sapply(ranef(model2),nrow)[1])
# SD for region in M2
sd_IdM2 <- round(as.numeric(attributes(VarCorr(model2)$"Id")$stddev), 3)

tribble(~stat, ~M1, ~M2,
        "\\textbf{Random Effects:}", NA, NA,
        "Number of Firms", NA, num_Id,
        "sd(Firms)", NA, sd_IdM2,
        "Akaike Inf. Crit.", round(AIC(model1), 3), round(AIC(model2), 3),
        "Bayesian Inf. Crit.", round(BIC(model1), 3), round(BIC(model2), 3)
        
        ) -> mod_stats

table <- capture.output({
stargazer(model1, model2, type="latex", 
          # ^  Notice M2 is called twice. I'm going somewhere with this.
          # Below: manually supply tidied coefficients and standard errors
          coef = list(tidyM1$estimate, tidyM2$estimate),
          se = list(tidyM1$std.error, tidyM2$std.error),
          omit.table.layout = "s",
          # ...but supply your own that you created (with random effects)
          add.lines = lapply(1:nrow(mod_stats), function(i) unlist(mod_stats[i, ])),
          notes="Model (1): Simple Ordinary Least Squares regression with intercept using Year and Same-Year Decarbonization Rate as predictors. \\ Model (2): Linear Mixed Effect Model with the same predictors as model (1) but with an added random intercept for the unique firm identifier",
          dep.var.labels="Next Year Decarbonization Rate",
          model.names = TRUE, 
          font.size = "small",
          table.placement = "H",
          title = "Model Comparison: Fixed Effects Only vs. Random Intercept for Firm Id",
          label = "tab:R1"
          )})


table <- gsub("\\begin{tabular}","\\resizebox{0.8\\textwidth}{!}{\\begin{tabular}", table,fixed=T)
table <- gsub("\\end{tabular}","\\end{tabular}}", table,fixed=T)
table <- table[-(1:3)]

cat(table, file = "../../thesis_tex/tables/R1.tex")

```


In the third model, we add an important categorical predictor: industry. As explained in the EDA, Industry is derived using the Global Industry Classification stantard and it comprehends 20 industry categories. The hypothesis we want to test is whether the industry a firm operates in significantly affects decarbonization rate, and I expect the result to show that it does. We chose as reference category the Software, Services industry, which is the category that corresponds to the lowest (best) mean decarbonization rate. In this way, coefficients of other industries are expected to be positive and will represent the difference in decarbonization rate compared to the reference category.

```{r}
# model3: adding industry and showing it's significant
model3 = lmer(Ghg.Change.Real.Next ~ Year + Ghg.Change.Real + Industry + (1|Id), data = data)

summary(model3)
model_performance(model3)
model_performance(model3)$AIC
```
As we can observe from the Table, when controlling for year and previous year decarbonization rate, and having firm Id as a random effect, almost all industry sectors are significant, and the results are in line with what we found in the Exploratory Data Analysis section. In particular, sectors that displayed a higher (worse) mean decarbonization rates, such as the Energy, Materials, and Transportation sectors, have higher coefficients. Therefore, the model predicts that firms in these sectors will have a lower next-year decarbonization rate compared to the reference category. This makes sense as these sectors are known to be more carbon-intensive, and the model suggests that the carbon-intensive nature holds true even when controlling for time  and previous year decarbonization rate. We can infer that there likely are factor that make a sector inherently difficult to decarbonize. An example to support this finding is the case of decarbonizing cement production, which is a key category in the Material sector and contributes to a significant portion of global emissions. Cement production is inherently carbon-intensive, and the industry has been struggling to find a viable alternative to the traditional production process. This is a clear example of how the industry a firm operates in can significantly affect its decarbonization rate. Key takeaway: a conversation on decarbonization must take into account sectors.

```{r}
# model 4: adding industry as a random effect
model4 = lmer(Ghg.Change.Real.Next ~ Year + Ghg.Change.Real + (1|Industry/Id), data = data)

summary(model4)
model_performance(model4)
model_performance(model4)$AIC
```
The fact that firms Ids are nested into sector, as each firm is assigned to a primary GICS sector, allows to add Industry as a random effect on the model, nested into firm Id. From now on, not only we will control for the correlation between each firm's timeseries, but we will also control for the correlation between each firm's timeseries within each industry, as shown in the second model.


Outputting the second table:
```{r}
to_tex_2 = function (a, b, title, file_name) {
class(a) <- "lmerMod"
class(b) <- "lmerMod"
tidyM1 <- broom::tidy(a)
tidyM2 <- broom::tidy(b) %>% filter(effect == "fixed")
 # Number of unique regions for that one random effect
num_Id <- as.numeric(sapply(ranef(model2),nrow)[1])
num_Industry <- as.numeric(sapply(ranef(b),nrow)[2])
# SD for region in M2
sd_IdM1 <- round(as.numeric(attributes(VarCorr(a)$"Id")$stddev), 3)
sd_IdM2 <- round(as.numeric(attributes(VarCorr(b)$"Id")$stddev), 3)
sd_IndustryM2 <- round(as.numeric(attributes(VarCorr(b)$"Industry")$stddev), 3)


tribble(~stat, ~M1, ~M2,
        "\\textbf{Random Effects:}", NA, NA,
        "Number of Firms", num_Id, num_Id,
        "Number of Industries", NA, num_Industry,
        "sd(Firms)", sd_IdM1, sd_IdM2,
        "sd(Industry)", NA, sd_IndustryM2,
        "Akaike Inf. Crit.", round(AIC(a), 3), round(AIC(b), 3),
        "Bayesian Inf. Crit.", round(BIC(a), 3), round(BIC(b), 3)
        
        ) -> mod_stats

table <- capture.output({
stargazer(a, b, type="latex", 
          # ^  Notice M2 is called twice. I'm going somewhere with this.
          # Below: manually supply tidied coefficients and standard errors
          coef = list(tidyM1$estimate, tidyM2$estimate),
          se = list(tidyM1$std.error, tidyM2$std.error),
          omit.table.layout = "s",
          # ...but supply your own that you created (with random effects)
          add.lines = lapply(1:nrow(mod_stats), function(i) unlist(mod_stats[i, ])),
          notes="Second model has firm Id and Industry as random intercepts.",
          dep.var.labels="Next Year Decarbonization Rate",
          model.names = TRUE, 
          title = title,
          single.row = TRUE,
          table.placement = "H",
          label = paste0("tab:", file_name)
          )})


table <- gsub("\\begin{tabular}","\\resizebox{0.8\\textwidth}{!}{\\begin{tabular}", table,fixed=T)
table <- gsub("\\end{tabular}","\\end{tabular}}", table,fixed=T)
table <- table[-(1:3)]

cat(table, file = file_name)

}

to_tex_2(model3, model4, "Model Comparison: Fixed Effects Only vs. Random Intercept for Firm Id and Industry", "../../thesis_tex/tables/R2.tex")
```

A predictor we will next consider is georgraphical location. Location is important in understanding decarbonization rates, as different countries have different policies and regulations that can affect a firm's ability to decarbonize. Initially, we will consider the continent a firm is located in. We will add continent as a fixed effect, and then as a random effect. Finally, I will add country as a random effect and compare the model fit. For the first model, we will use Europe as the reference category, as it is the continent with the lowest (best) mean decarbonization rate. We expect the coefficients of the other continents to be positive, and to represent the difference in decarbonization rate compared to the reference category. 
```{r}
# model 6: adding continent as a predictor
model6 = lmer(Ghg.Change.Real.Next ~ Year +  Ghg.Change.Real + Continent + (1|Industry/Id), data = data)

summary(model6)
model_performance(model6)
model_performance(model6)$AIC
```

As we can observe from the table results, when controlling for year and current decarbonization rate, and having firm Id nested into industry as a random effect, the coefficients for the continents are all positive and significant. This means that firms located in these continents have a lower next-year decarbonization rate compared to the reference category, Europe. This is in line with what we found in the EDA, and it is consistent with the fact that Europe has been a leader in climate policy and has been implementing more stringent regulations compared to other continents. The model suggests that firms located in Europe have a higher next-year decarbonization rate compared to firms located in other continents. The key takeaway is that, like industry, it is important to consider the geographical location of a firm when discussing decarbonization. I will therefore add geograhpilcal location as a random effect, and since country has the lowest AIC score between the two random effect parameters - continent and country -I will add Conutry as a random effect. 

```{r}
# model 7: adding country as a random effect: marginal improvement (might as well leave it out)
model7 = lmer(Ghg.Change.Real.Next ~ Year + Ghg.Change.Real + (1|Industry/Id) + (1 |Continent/Country), data = data)

summary(model7)
model_performance(model7)
model_performance(model7)$AIC
```




```{r}
class(model6) <- "lmerMod"
class(model7) <- "lmerMod"
tidyM1 <- broom::tidy(model6) %>% filter(effect == "fixed")
tidyM2 <- broom::tidy(model7) %>% filter(effect == "fixed")
 # Number of unique regions for that one random effect
num_Id <- as.numeric(sapply(ranef(model7),nrow)[1])
num_Country <- as.numeric(sapply(ranef(model7),nrow)[2])
num_Industry <- as.numeric(sapply(ranef(model7),nrow)[3])
num_Continent <- as.numeric(sapply(ranef(model7),nrow)[4])

sd_IdM1 <- round(as.numeric(attributes(VarCorr(model6)$"Id")$stddev), 3)
sd_IndustryM1 <- round(as.numeric(attributes(VarCorr(model6)$"Industry")$stddev), 3)
sd_ContinentM1 <- round(as.numeric(attributes(VarCorr(model6)$"Continent")$stddev), 3)

sd_IdM2 <- round(as.numeric(attributes(VarCorr(model7)$"Id")$stddev), 3)
sd_IndustryM2 <- round(as.numeric(attributes(VarCorr(model7)$"Industry")$stddev), 3)
sd_ContinentM2 <- round(as.numeric(attributes(VarCorr(model7)$"Continent")$stddev), 3)
sd_CountryM2 <- round(as.numeric(attributes(VarCorr(model7)$"Country")$stddev), 3)


tribble(~stat, ~M1, ~M2,
        "\\textbf{Random Effects:}", NA, NA,
        "Number of Firms", num_Id, num_Id,
        "Number of Industries", num_Industry, num_Industry,
        "Number of Continents", num_Continent, num_Continent,
         "Number of Countries", NA, num_Country,
        "sd(Firms:Industry)", sd_IdM1, sd_IdM2,
        "sd(Industry)", sd_IndustryM1, sd_IndustryM2,
        "sd(Continent)", NA, sd_ContinentM2,
        "sd(Country:Continent)", NA, sd_CountryM2,
        "Akaike Inf. Crit.", round(AIC(model6), 3), round(AIC(model7), 3),
        "Bayesian Inf. Crit.", round(BIC(model6), 3), round(BIC(model7), 3)
        
        ) -> mod_stats

table <- capture.output({
stargazer(model6, model7, type="latex", 
          # ^  Notice M2 is called twice. I'm going somewhere with this.
          # Below: manually supply tidied coefficients and standard errors
          coef = list(tidyM1$estimate, tidyM2$estimate),
          se = list(tidyM1$std.error, tidyM2$std.error),
          omit.table.layout = "s",
          # ...but supply your own that you created (with random effects)
          add.lines = lapply(1:nrow(mod_stats), function(i) unlist(mod_stats[i, ])),
          notes="Second model adds Country nested in Continent as random intercepts.",
          dep.var.labels="Next Year Decarbonization Rate",
          model.names = FALSE, 
          title = "Impact of Country and Continent on Decarbonization",
          single.row = TRUE,
          table.placement = "H",
          label = paste0("tab:", "R3"))})

table <- gsub("\\begin{tabular}","\\resizebox{0.8\\textwidth}{!}{\\begin{tabular}", table,fixed=T)
table <- gsub("\\end{tabular}","\\end{tabular}}", table,fixed=T)
table <- table[-(1:3)]

cat(table, file = "../../thesis_tex/tables/R3.tex")

```


Next, we will consider the financial predictors, which not only allow to differenciate between firms based on their financial performance, size, and growth, but also to understand the impact of financial performance itself on decarbonization. We will consider the following predictors: market capitalization, total assets, revenue, net income over assets, return on equity, and growth in assets and employees. We will start by adding all of them to the model, and then we will iteratively remove the ones that are not significant. 
```{r}
# model 8: adding financial predictors - ALL

model8 = lmer(Ghg.Change.Real.Next ~ Year + Ghg.Change.Real +Market.Cap + Employees + Revenue + Employees.1Y.Gr + Assets.1Y.Gr + Tot.Assets + Net.Income.Over.Assets + Roe +  (1|Industry/Id) + (1 |Continent/Country), data = data)

summary(model8)
model_performance(model8)
model_performance(model8)$AIC

```

```{r}
# keep only market cap and total assets - testing employees
model9 = lmer(Ghg.Change.Real.Next ~ Year + Ghg.Change.Real +  Market.Cap + Revenue + Employees.1Y.Gr + (1|Industry/Id) + (1 |Continent/Country), data = data)

summary(model9)
model_performance(model9)
model_performance(model9)$AIC
```

```{r}
# testing assets and employees
model10 = lmer(Ghg.Change.Real.Next ~ Year + Ghg.Change.Real + Market.Cap + Revenue +  Assets.1Y.Gr + (1|Industry/Id) + (1 |Continent/Country), data = data)

summary(model10)
model_performance(model10)
model_performance(model10)$AIC
```
```{r}
# putting 8-9-10 into stargazer
class(model8) <- "lmerMod"
class(model9) <- "lmerMod"
class(model10) <- "lmerMod"
tidyM1 <- broom::tidy(model8) %>% filter(effect == "fixed")
tidyM2 <- broom::tidy(model9) %>% filter(effect == "fixed")
tidyM3 <- broom::tidy(model10) %>% filter(effect == "fixed")
 # Number of unique regions for that one random effect
num_Id <- as.numeric(sapply(ranef(model8),nrow)[1])
num_Country <- as.numeric(sapply(ranef(model8),nrow)[2])
num_Industry <- as.numeric(sapply(ranef(model8),nrow)[3])
num_Continent <- as.numeric(sapply(ranef(model8),nrow)[4])

sd_IdM1 <- round(as.numeric(attributes(VarCorr(model8)$"Id")$stddev), 3)
sd_IndustryM1 <- round(as.numeric(attributes(VarCorr(model8)$"Industry")$stddev), 3)
sd_ContinentM1 <- round(as.numeric(attributes(VarCorr(model8)$"Continent")$stddev), 3)
sd_CountryM1 <- round(as.numeric(attributes(VarCorr(model8)$"Country")$stddev), 3)

sd_IdM2 <- round(as.numeric(attributes(VarCorr(model9)$"Id")$stddev), 3)
sd_IndustryM2 <- round(as.numeric(attributes(VarCorr(model9)$"Industry")$stddev), 3)
sd_ContinentM2 <- round(as.numeric(attributes(VarCorr(model9)$"Continent")$stddev), 3)
sd_CountryM2 <- round(as.numeric(attributes(VarCorr(model9)$"Country")$stddev), 3)

sd_IdM3 <- round(as.numeric(attributes(VarCorr(model10)$"Id")$stddev), 3)
sd_IndustryM3 <- round(as.numeric(attributes(VarCorr(model10)$"Industry")$stddev), 3)
sd_ContinentM3 <- round(as.numeric(attributes(VarCorr(model10)$"Continent")$stddev), 3)
sd_CountryM3 <- round(as.numeric(attributes(VarCorr(model10)$"Country")$stddev), 3)



tribble(~stat, ~M1, ~M2, ~M3,
        "\\textbf{Random Effects:}", NA, NA, NA,
        "Number of Firms", num_Id, num_Id, num_Id,
        "Number of Industries", num_Industry, num_Industry, num_Industry,
        "Number of Continents", num_Continent, num_Continent, num_Continent,
         "Number of Countries", num_Country, num_Country, num_Country,
        "sd(Firms:Industry)", sd_IdM1, sd_IdM2, sd_IdM3,
        "sd(Industry)", sd_IndustryM1, sd_IndustryM2, sd_IndustryM3,
        "sd(Continent)", sd_ContinentM1, sd_ContinentM2, sd_ContinentM3,
        "sd(Country:Continent)", sd_CountryM1, sd_CountryM2, sd_CountryM3,
        "Akaike Inf. Crit.", round(AIC(model6), 3), round(AIC(model7), 3), round(AIC(model8), 3),
        "Bayesian Inf. Crit.", round(BIC(model6), 3), round(BIC(model7), 3) , round(BIC(model8), 3)
        
        ) -> mod_stats

table <- capture.output({
stargazer(model8, model9, model10, type="latex", 
          # ^  Notice M2 is called twice. I'm going somewhere with this.
          # Below: manually supply tidied coefficients and standard errors
          coef = list(tidyM1$estimate, tidyM2$estimate),
          se = list(tidyM1$std.error, tidyM2$std.error),
          omit.table.layout = "s",
          # ...but supply your own that you created (with random effects)
          add.lines = lapply(1:nrow(mod_stats), function(i) unlist(mod_stats[i, ])),
          notes="Third Model focuses on employees and assets growth",
          dep.var.labels="Next Year Decarbonization Rate",
          model.names = FALSE, 
          title = "Impact of Financial Predictors on Decarbonization",
          single.row = TRUE,
          table.placement = "H",
          label = paste0("tab:", "R4"))})

table <- gsub("\\begin{tabular}","\\resizebox{0.8\\textwidth}{!}{\\begin{tabular}", table,fixed=T)
table <- gsub("\\end{tabular}","\\end{tabular}}", table,fixed=T)
table <- table[-(1:3)]

cat(table, file = "../../thesis_tex/tables/R4.tex")


```



Emission scopes: No is the same as No Data so I will only include the yes for each category.
```{r}
# make proportion verified scope1 = 1 if it's 100 else 0
data$Proportion.Verified.Scope1 = ifelse(data$Proportion.Verified.Scope1 == 100, 1, 0)
data$Proportion.Verified.Scope2 = ifelse(data$Proportion.Verified.Scope2 == 100, 1, 0)

# first convert them to a single factor column
data$Type.Scope1 = ifelse(data$Type.Scope1.Limited == 1, "Limited", ifelse(data$Type.Scope1.Moderate == 1, "Moderate", ifelse(data$Type.Scope1.N.A == 1, "N.A", ifelse(data$Type.Scope1.Reasonable == 1, "Reasonable", "Third.Party.Underway"))))

# merge limited and moderate in limited/moderate
data$Type.Scope1 = ifelse(data$Type.Scope1 == "Limited" | data$Type.Scope1 == "Moderate", "Limited/Moderate", data$Type.Scope1)
data$Type.Scope1 = as.factor(data$Type.Scope1)
data$Type.Scope1 = relevel(data$Type.Scope1, ref = "Reasonable")
```

ONLY GHG STUFF
```{r}
model13.1 = lmer(Ghg.Change.Real.Next ~ Year + Ghg.Change.Real + Market.Cap + Revenue +  Ghg1 + Ghg2Location + Ghg2Market + Ghg3.Total + Ghg3.Count + Ghg1.Na + Ghg2Location.Na + Ghg2Market.Na + Ghg3.Total.Na + Methane.Emissions + (1|Industry/Id) + (1 |Continent/Country), data = data)

summary(model13.1)
model_performance(model13.1)
model_performance(model13.1)$AIC
```
ONLY VERIFICATION STUFF
```{r}
model13.2 = lmer(Ghg.Change.Real.Next ~ Year + Ghg.Change.Real + Market.Cap + Revenue +  Type.Scope1 + Ghg.Verification.Scope1.Yes + Ghg.Verification.Scope2.Yes + Ghg.Verification.Scope3.Yes + (1|Industry/Id) + (1 |Continent/Country), data = data)

summary(model13.2)
model_performance(model13.2)
model_performance(model13.2)$AIC
```


BOTH
```{r}
model13.3 = lmer(Ghg.Change.Real.Next ~ Year + Ghg.Change.Real + Market.Cap + Revenue +  Ghg1 + Ghg2Location + Ghg2Market + Ghg3.Total + Ghg3.Count + Ghg1.Na + Ghg2Location.Na + Ghg2Market.Na + Ghg3.Total.Na + Methane.Emissions + Type.Scope1 + Ghg.Verification.Scope1.Yes + Ghg.Verification.Scope2.Yes + Ghg.Verification.Scope3.Yes + (1|Industry/Id) + (1 |Continent/Country), data = data)

summary(model13.3)
model_performance(model13.3)
model_performance(model13.3)$AIC

```
The only significant predictors are whether the company verifies scope 3 emissions, and whether 100% of scope 2 emissions are verified. 
```{r}
# model 14
model13.4 = lmer(Ghg.Change.Real.Next ~ Year + Ghg.Change.Real + Market.Cap + Revenue + Type.Scope1 + Ghg.Verification.Scope3.Yes + Ghg1 + Ghg2Location + Ghg3.Count + Ghg1.Na + Ghg2Market.Na + Methane.Emissions + (1|Industry/Id) + (1 |Continent/Country), data = data)

summary(model13.4)
model_performance(model13.4)
model_performance(model13.4)$AIC
```


```{r}
# putting 13.1, 13.2, 13.3, 13.4 into stargazer
class(model13.1) <- "lmerMod"
class(model13.2) <- "lmerMod"
class(model13.3) <- "lmerMod"
class(model13.4) <- "lmerMod"
tidyM1 <- broom::tidy(model13.1) %>% filter(effect == "fixed")
tidyM2 <- broom::tidy(model13.2) %>% filter(effect == "fixed")
tidyM3 <- broom::tidy(model13.3) %>% filter(effect == "fixed")
tidyM4 <- broom::tidy(model13.4) %>% filter(effect == "fixed")
 # Number of unique regions for that one random effect
num_Id <- as.numeric(sapply(ranef(model13.1),nrow)[1])
num_Country <- as.numeric(sapply(ranef(model13.1),nrow)[2])
num_Industry <- as.numeric(sapply(ranef(model13.1),nrow)[3])
num_Continent <- as.numeric(sapply(ranef(model13.1),nrow)[4])

sd_IdM1 <- round(as.numeric(attributes(VarCorr(model13.1)$"Id")$stddev), 3)
sd_IndustryM1 <- round(as.numeric(attributes(VarCorr(model13.1)$"Industry")$stddev), 3)
sd_ContinentM1 <- round(as.numeric(attributes(VarCorr(model13.1)$"Continent")$stddev), 3)
sd_CountryM1 <- round(as.numeric(attributes(VarCorr(model13.1)$"Country")$stddev), 3)

sd_IdM2 <- round(as.numeric(attributes(VarCorr(model13.2)$"Id")$stddev), 3)
sd_IndustryM2 <- round(as.numeric(attributes(VarCorr(model13.2)$"Industry")$stddev), 3)
sd_ContinentM2 <- round(as.numeric(attributes(VarCorr(model13.2)$"Continent")$stddev), 3)
sd_CountryM2 <- round(as.numeric(attributes(VarCorr(model13.2)$"Country")$stddev), 3)

sd_IdM3 <- round(as.numeric(attributes(VarCorr(model13.3)$"Id")$stddev), 3)
sd_IndustryM3 <- round(as.numeric(attributes(VarCorr(model13.3)$"Industry")$stddev), 3)
sd_ContinentM3 <- round(as.numeric(attributes(VarCorr(model13.3)$"Continent")$stddev), 3)
sd_CountryM3 <- round(as.numeric(attributes(VarCorr(model13.3)$"Country")$stddev), 3)

sd_IdM4 <- round(as.numeric(attributes(VarCorr(model13.4)$"Id")$stddev), 3)
sd_IndustryM4 <- round(as.numeric(attributes(VarCorr(model13.4)$"Industry")$stddev), 3)
sd_ContinentM4 <- round(as.numeric(attributes(VarCorr(model13.4)$"Continent")$stddev), 3)
sd_CountryM4 <- round(as.numeric(attributes(VarCorr(model13.4)$"Country")$stddev), 3)


tribble(~stat, ~M1, ~M2, ~M3, ~M4,
        "\\textbf{Random Effects:}", NA, NA, NA, NA,
        "Number of Firms", num_Id, num_Id, num_Id, num_Id,
        "Number of Industries", num_Industry, num_Industry, num_Industry, num_Industry,
        "Number of Continents", num_Continent, num_Continent, num_Continent, num_Continent,
         "Number of Countries", num_Country, num_Country, num_Country, num_Country,
        "sd(Firms:Industry)", sd_IdM1, sd_IdM2, sd_IdM3, sd_IdM4,
        "sd(Industry)", sd_IndustryM1, sd_IndustryM2, sd_IndustryM3, sd_IndustryM4,
        "sd(Continent)", sd_ContinentM1, sd_ContinentM2, sd_ContinentM3, sd_ContinentM4,
        "sd(Country:Continent)", sd_CountryM1, sd_CountryM2, sd_CountryM3, sd_CountryM4,
        "Akaike Inf. Crit.", round(AIC(model13.1), 3), round(AIC(model13.2), 3), round(AIC(model13.3), 3), round(AIC(model13.4), 3),
        "Bayesian Inf. Crit.", round(BIC(model13.1), 3), round(BIC(model13.2), 3), round(BIC(model13.3), 3), round(BIC(model13.4), 3)
        
        ) -> mod_stats


table <- capture.output({
stargazer(model13.1, model13.2, model13.3, model13.4, type="latex", 
          # ^  Notice M2 is called twice. I'm going somewhere with this.
          # Below: manually supply tidied coefficients and standard errors
          coef = list(tidyM1$estimate, tidyM2$estimate, tidyM3$estimate, tidyM4$estimate),
          se = list(tidyM1$std.error, tidyM2$std.error, tidyM3$std.error, tidyM4$std.error),
          omit.table.layout = "s",
          # ...but supply your own that you created (with random effects)
          add.lines = lapply(1:nrow(mod_stats), function(i) unlist(mod_stats[i, ])),
          notes="Fourth Model focuses on GHG and Verification",
          dep.var.labels="Next Year Decarbonization Rate",
          model.names = FALSE, 
          title = "Impact of GHG and Verification on Decarbonization",
          single.row = TRUE,
          table.placement = "H",
          label = paste0("tab:", "R5"))})

table <- gsub("\\begin{tabular}","\\resizebox{0.8\\textwidth}{!}{\\begin{tabular}", table,fixed=T)
table <- gsub("\\end{tabular}","\\end{tabular}}", table,fixed=T)
table <- table[-(1:3)]

cat(table, file = "../../thesis_tex/tables/R5.tex")

```

```{r}
# add board oversight and incentive binary
model14.1 = lmer(Ghg.Change.Real.Next ~ Year + Ghg.Change.Real + Market.Cap + Revenue +  Type.Scope1 + Ghg.Verification.Scope3.Yes + + Ghg1 + Ghg2Location + Ghg3.Count + Ghg1.Na + Ghg2Market.Na + Methane.Emissions + Cdp.Boardoversight.I + Cdp.Incentivebinary.I + (1|Industry/Id) + (1 |Continent/Country), data = data)

summary(model14.1)
model_performance(model14.1)
model_performance(model14.1)$AIC
```

Just Methods Single:
```{r}
model14.2 = lmer(Ghg.Change.Real.Next ~ Year + Ghg.Change.Real + Market.Cap + Revenue +  Type.Scope1 + Ghg.Verification.Scope3.Yes + Ghg1 + Ghg2Location + Ghg3.Count + Ghg1.Na + Ghg2Market.Na + Methane.Emissions + Method.Ind + (1|Industry/Id) + (1 |Continent/Country), data = data)

summary(model14.2)
model_performance(model14.2)
model_performance(model14.2)$AIC

```


```{r}
model14.3 = lmer(Ghg.Change.Real.Next ~ Year + Ghg.Change.Real + Market.Cap + Revenue +  Type.Scope1 + Ghg.Verification.Scope3.Yes + Ghg1 + Ghg2Location + Ghg3.Count + Ghg1.Na + Ghg2Market.Na + Methane.Emissions + Method.Ind + Cdp.Boardoversight.I + Cdp.Incentivebinary.I + (1|Industry/Id) + (1 |Continent/Country), data = data)

summary(model14.3)
model_performance(model14.3)
model_performance(model14.3)$AIC
```

```{r}
model14.4 = lmer(Ghg.Change.Real.Next ~ Year + Ghg.Change.Real + Market.Cap + Revenue +  Type.Scope1 + Ghg.Verification.Scope3.Yes + Ghg1 + Ghg2Location + Ghg3.Count + Ghg1.Na + Ghg2Market.Na + Methane.Emissions + Method.Ind + Cdp.Incentivebinary.I + (1|Industry/Id) + (1 |Continent/Country), data = data)

summary(model14.4)
model_performance(model14.4)
model_performance(model14.4)$AIC
```



```{r}
# putting 14.1, 14.2, 14.3, 14.4 into stargazer
class(model14.1) <- "lmerMod"
class(model14.2) <- "lmerMod"
class(model14.3) <- "lmerMod"
class(model14.4) <- "lmerMod"

tidyM1 <- broom::tidy(model14.1) %>% filter(effect == "fixed")
tidyM2 <- broom::tidy(model14.2) %>% filter(effect == "fixed")
tidyM3 <- broom::tidy(model14.3) %>% filter(effect == "fixed")
tidyM4 <- broom::tidy(model14.4) %>% filter(effect == "fixed")

 # Number of unique regions for that one random effect
num_Id <- as.numeric(sapply(ranef(model14.1),nrow)[1])
num_Country <- as.numeric(sapply(ranef(model14.1),nrow)[2])
num_Industry <- as.numeric(sapply(ranef(model14.1),nrow)[3])
num_Continent <- as.numeric(sapply(ranef(model14.1),nrow)[4])

sd_IdM1 <- round(as.numeric(attributes(VarCorr(model14.1)$"Id")$stddev), 3)
sd_IndustryM1 <- round(as.numeric(attributes(VarCorr(model14.1)$"Industry")$stddev), 3)
sd_ContinentM1 <- round(as.numeric(attributes(VarCorr(model14.1)$"Continent")$stddev), 3)
sd_CountryM1 <- round(as.numeric(attributes(VarCorr(model14.1)$"Country")$stddev), 3)

sd_IdM2 <- round(as.numeric(attributes(VarCorr(model14.2)$"Id")$stddev), 3)
sd_IndustryM2 <- round(as.numeric(attributes(VarCorr(model14.2)$"Industry")$stddev), 3)
sd_ContinentM2 <- round(as.numeric(attributes(VarCorr(model14.2)$"Continent")$stddev), 3)
sd_CountryM2 <- round(as.numeric(attributes(VarCorr(model14.2)$"Country")$stddev), 3)

sd_IdM3 <- round(as.numeric(attributes(VarCorr(model14.3)$"Id")$stddev), 3)
sd_IndustryM3 <- round(as.numeric(attributes(VarCorr(model14.3)$"Industry")$stddev), 3)
sd_ContinentM3 <- round(as.numeric(attributes(VarCorr(model14.3)$"Continent")$stddev), 3)
sd_CountryM3 <- round(as.numeric(attributes(VarCorr(model14.3)$"Country")$stddev), 3)

sd_IdM4 <- round(as.numeric(attributes(VarCorr(model14.4)$"Id")$stddev), 3)
sd_IndustryM4 <- round(as.numeric(attributes(VarCorr(model14.4)$"Industry")$stddev), 3)
sd_ContinentM4 <- round(as.numeric(attributes(VarCorr(model14.4)$"Continent")$stddev), 3)
sd_CountryM4 <- round(as.numeric(attributes(VarCorr(model14.4)$"Country")$stddev), 3)


tribble(~stat, ~M1, ~M2, ~M3, ~M4,
        "\\textbf{Random Effects:}", NA, NA, NA, NA,
        "Number of Firms", num_Id, num_Id, num_Id, num_Id,
        "Number of Industries", num_Industry, num_Industry, num_Industry, num_Industry,
        "Number of Continents", num_Continent, num_Continent, num_Continent, num_Continent,
         "Number of Countries", num_Country, num_Country, num_Country, num_Country,
        "sd(Firms:Industry)", sd_IdM1, sd_IdM2, sd_IdM3, sd_IdM4,
        "sd(Industry)", sd_IndustryM1, sd_IndustryM2, sd_IndustryM3, sd_IndustryM4,
        "sd(Continent)", sd_ContinentM1, sd_ContinentM2, sd_ContinentM3, sd_ContinentM4,
        "sd(Country:Continent)", sd_CountryM1, sd_CountryM2, sd_CountryM3, sd_CountryM4,
        "Akaike Inf. Crit.", round(AIC(model14.1), 3), round(AIC(model14.2), 3), round(AIC(model14.3), 3), round(AIC(model14.4), 3),
        "Bayesian Inf. Crit.", round(BIC(model14.1), 3), round(BIC(model14.2), 3), round(BIC(model14.3), 3), round(BIC(model14.4), 3)
        
        ) -> mod_stats


table <- capture.output({
stargazer(model14.1, model14.2, model14.3, model14.4, type="latex", 
          # ^  Notice M2 is called twice. I'm going somewhere with this.
          # Below: manually supply tidied coefficients and standard errors
          coef = list(tidyM1$estimate, tidyM2$estimate, tidyM3$estimate, tidyM4$estimate),
          se = list(tidyM1$std.error, tidyM2$std.error, tidyM3$std.error, tidyM4$std.error),
          omit.table.layout = "s",
          # ...but supply your own that you created (with random effects)
          add.lines = lapply(1:nrow(mod_stats), function(i) unlist(mod_stats[i, ])),
          notes="Fifth Model focuses on GHG, Verification, and Incentives",
          dep.var.labels="Next Year Decarbonization Rate",
          model.names = FALSE, 
          title = "GHG, Verification, Incentives, Targets, Risks and Opportunities",
          single.row = TRUE,
          table.placement = "H",
          label = paste0("tab:", "R6"))})

table <- gsub("\\begin{tabular}","\\resizebox{0.8\\textwidth}{!}{\\begin{tabular}", table,fixed=T)
table <- gsub("\\end{tabular}","\\end{tabular}}", table,fixed=T)
table <- table[-(1:3)]

cat(table, file = "../../thesis_tex/tables/R6.tex")

```
```{r}

data$Cdp.Baseyear.Mean = data$Cdp.Baseyear.Mean - 2011

# if negative set to zero
data$Cdp.Baseyear.Mean = ifelse(data$Cdp.Baseyear.Mean < 0, 0, data$Cdp.Baseyear.Mean)

```



```{r}
# convert targettype intensity and absolute as factors

model15.1 = lmer(Ghg.Change.Real.Next ~ Year + Ghg.Change.Real + Market.Cap + Revenue +  Type.Scope1 + Ghg.Verification.Scope3.Yes + Ghg1 + Ghg2Location + Ghg3.Count + Ghg1.Na + Ghg2Market.Na + Methane.Emissions + Method.Ind + Cdp.Incentivebinary.I + Cdp.Baseyearemission.Mean + Cdp.Targetscope.Percent.Mean + Cdp.Targetamount.Mean + Cdp.Targettype.Absolute + Cdp.Targettype.Intensity +  (1|Industry/Id) + (1 |Continent/Country), data = data)


summary(model15.1)
model_performance(model15.1)
model_performance(model15.1)$AIC
```

```{r}
# cdp aggregated risk 
data$Cdp.Aggregated.Risk = data$Cdp.Risk.Transition + data$Cdp.Risk.Physical

#if greater than 1 set to 1
data$Cdp.Aggregated.Risk = ifelse(data$Cdp.Aggregated.Risk > 1, 1, data$Cdp.Aggregated.Risk)
```

```{r}
model15.2 = lmer(Ghg.Change.Real.Next ~ Year + Ghg.Change.Real + Market.Cap + Revenue +  Type.Scope1 + Ghg.Verification.Scope3.Yes + Ghg1 + Ghg2Location + Ghg3.Count + Ghg1.Na + Ghg2Market.Na + Methane.Emissions + Method.Ind + Cdp.Incentivebinary.I + Cdp.Aggregated.Risk +  Cdp.Aggregated.Opp +  (1|Industry/Id) + (1 |Continent/Country), data = data)

summary(model15.2)
model_performance(model15.2)
model_performance(model15.2)$AIC
```
```{r}
model15.3 = lmer(Ghg.Change.Real.Next ~ Year + Ghg.Change.Real + Market.Cap + Revenue +  Type.Scope1 + Ghg.Verification.Scope3.Yes + Ghg1 + Ghg2Location + Ghg3.Count + Ghg1.Na + Ghg2Market.Na + Methane.Emissions + Method.Ind + Cdp.Incentivebinary.I + + Cdp.Baseyearemission.Mean + Cdp.Targetscope.Percent.Mean + Cdp.Targetamount.Mean + Cdp.Targettype.Absolute + Cdp.Targettype.Intensity + Cdp.Aggregated.Risk +  Cdp.Aggregated.Opp + (1|Industry/Id) + (1 |Continent/Country), data = data)

summary(model15.3)
model_performance(model15.3)
model_performance(model15.3)$AIC
```

```{r}
model15.4 = lmer(Ghg.Change.Real.Next ~ Year + Ghg.Change.Real + Market.Cap + Revenue +  Type.Scope1 + Ghg.Verification.Scope3.Yes + Ghg1 + Ghg2Location + Ghg3.Count + Ghg1.Na + Ghg2Market.Na + Methane.Emissions + Method.Ind + Cdp.Targetamount.Mean + Cdp.Targettype.Absolute + Cdp.Aggregated.Risk +  Cdp.Aggregated.Opp + (1|Industry/Id) + (1 |Continent/Country), data = data)

summary(model15.4)
model_performance(model15.4)
model_performance(model15.4)$AIC
```

```{r}
# putting 15.1, 15.2, 15.3, 15.4 into stargazer
class(model15.1) <- "lmerMod"
class(model15.2) <- "lmerMod"
class(model15.3) <- "lmerMod"
class(model15.4) <- "lmerMod"

tidyM1 <- broom::tidy(model15.1) %>% filter(effect == "fixed")
tidyM2 <- broom::tidy(model15.2) %>% filter(effect == "fixed")
tidyM3 <- broom::tidy(model15.3) %>% filter(effect == "fixed")
tidyM4 <- broom::tidy(model15.4) %>% filter(effect == "fixed")

 # Number of unique regions for that one random effect
num_Id <- as.numeric(sapply(ranef(model15.1),nrow)[1])
num_Country <- as.numeric(sapply(ranef(model15.1),nrow)[2])
num_Industry <- as.numeric(sapply(ranef(model15.1),nrow)[3])
num_Continent <- as.numeric(sapply(ranef(model15.1),nrow)[4])

sd_IdM1 <- round(as.numeric(attributes(VarCorr(model15.1)$"Id")$stddev), 3)
sd_IndustryM1 <- round(as.numeric(attributes(VarCorr(model15.1)$"Industry")$stddev), 3)
sd_ContinentM1 <- round(as.numeric(attributes(VarCorr(model15.1)$"Continent")$stddev), 3)
sd_CountryM1 <- round(as.numeric(attributes(VarCorr(model15.1)$"Country")$stddev), 3)

sd_IdM2 <- round(as.numeric(attributes(VarCorr(model15.2)$"Id")$stddev), 3)
sd_IndustryM2 <- round(as.numeric(attributes(VarCorr(model15.2)$"Industry")$stddev), 3)
sd_ContinentM2 <- round(as.numeric(attributes(VarCorr(model15.2)$"Continent")$stddev), 3)
sd_CountryM2 <- round(as.numeric(attributes(VarCorr(model15.2)$"Country")$stddev), 3)

sd_IdM3 <- round(as.numeric(attributes(VarCorr(model15.3)$"Id")$stddev), 3)
sd_IndustryM3 <- round(as.numeric(attributes(VarCorr(model15.3)$"Industry")$stddev), 3)
sd_ContinentM3 <- round(as.numeric(attributes(VarCorr(model15.3)$"Continent")$stddev), 3)
sd_CountryM3 <- round(as.numeric(attributes(VarCorr(model15.3)$"Country")$stddev), 3)

sd_IdM4 <- round(as.numeric(attributes(VarCorr(model15.4)$"Id")$stddev), 3)
sd_IndustryM4 <- round(as.numeric(attributes(VarCorr(model15.4)$"Industry")$stddev), 3)
sd_ContinentM4 <- round(as.numeric(attributes(VarCorr(model15.4)$"Continent")$stddev), 3)
sd_CountryM4 <- round(as.numeric(attributes(VarCorr(model15.4)$"Country")$stddev), 3)


tribble(~stat, ~M1, ~M2, ~M3, ~M4,
        "\\textbf{Random Effects:}", NA, NA, NA, NA,
        "Number of Firms", num_Id, num_Id, num_Id, num_Id,
        "Number of Industries", num_Industry, num_Industry, num_Industry, num_Industry,
        "Number of Continents", num_Continent, num_Continent, num_Continent, num_Continent,
         "Number of Countries", num_Country, num_Country, num_Country, num_Country,
        "sd(Firms:Industry)", sd_IdM1, sd_IdM2, sd_IdM3, sd_IdM4,
        "sd(Industry)", sd_IndustryM1, sd_IndustryM2, sd_IndustryM3, sd_IndustryM4,
        "sd(Continent)", sd_ContinentM1, sd_ContinentM2, sd_ContinentM3, sd_ContinentM4,
        "sd(Country:Continent)", sd_CountryM1, sd_CountryM2, sd_CountryM3, sd_CountryM4,
        "Akaike Inf. Crit.", round(AIC(model15.1), 3), round(AIC(model15.2), 3), round(AIC(model15.3), 3), round(AIC(model15.4), 3),
        "Bayesian Inf. Crit.", round(BIC(model15.1), 3), round(BIC(model15.2), 3), round(BIC(model15.3), 3), round(BIC(model15.4), 3)
        
        ) -> mod_stats


table <- capture.output({
stargazer(model15.1, model15.2, model15.3, model15.4, type="latex", 
          # ^  Notice M2 is called twice. I'm going somewhere with this.
          # Below: manually supply tidied coefficients and standard errors
          coef = list(tidyM1$estimate, tidyM2$estimate, tidyM3$estimate, tidyM4$estimate),
          se = list(tidyM1$std.error, tidyM2$std.error, tidyM3$std.error, tidyM4$std.error),
          omit.table.layout = "s",
          # ...but supply your own that you created (with random effects)
          add.lines = lapply(1:nrow(mod_stats), function(i) unlist(mod_stats[i, ])),
          notes="Sixth Model focuses on GHG, Verification, and Incentives",
          dep.var.labels="Next Year Decarbonization Rate",
          model.names = FALSE, 
          title = "Impact of GHG, Verification, Incentives, Targets, Risks and Opportunities on Decarbonization",
          single.row = TRUE,
          table.placement = "H",
          label = paste0("tab:", "R7"))})

table <- gsub("\\begin{tabular}","\\resizebox{0.8\\textwidth}{!}{\\begin{tabular}", table,fixed=T)
table <- gsub("\\end{tabular}","\\end{tabular}}", table,fixed=T)
table <- table[-(1:3)]

cat(table, file = "../../thesis_tex/tables/R7.tex")

```

```{r}
model16.1 = lmer(Ghg.Change.Real.Next ~ Year + Ghg.Change.Real + Market.Cap + Revenue +  Type.Scope1 + Ghg.Verification.Scope3.Yes + Ghg1 + Ghg2Location + Ghg3.Count + Ghg1.Na + Ghg2Market.Na + Methane.Emissions + Method.Ind + Cdp.Targetamount.Mean + Cdp.Targettype.Absolute + Cdp.Aggregated.Risk +  Cdp.Aggregated.Opp + Initiative.Scope1 + Initiative.Scope2 + Initiative.Scope3 + Absent.Cdp.Initiative.Firm.Year.Processed.Csv + (1|Industry/Id) + (1 |Continent/Country), data = data)



# Initiative.Scope1 + Initiative.Scope2 + Initiative.Scope3 + Co2.Counter + Msaving.Counter + # Investment.Counter + Investment.Total.Log1P + Absent.Cdp.Initiative.Firm.Year.Processed.Csv


summary(model16.1)
model_performance(model16.1)
```

```{r}
model16.2 = lmer(Ghg.Change.Real.Next ~ Year + Ghg.Change.Real + Market.Cap + Revenue +  Type.Scope1 + Ghg.Verification.Scope3.Yes + Ghg1 + Ghg2Location + Ghg3.Count + Ghg1.Na + Ghg2Market.Na + Methane.Emissions + Method.Ind + Cdp.Targetamount.Mean + Cdp.Targettype.Absolute + Cdp.Aggregated.Risk +  Cdp.Aggregated.Opp + Co2.Counter + Msaving.Counter + Investment.Counter + Investment.Total.Log1P  + (1|Industry/Id) + (1 |Continent/Country), data = data)


summary(model16.2)
model_performance(model16.2)
```

```{r}
model16.3 = lmer(Ghg.Change.Real.Next ~ Year + Ghg.Change.Real + Market.Cap + Revenue +  Type.Scope1 + Ghg.Verification.Scope3.Yes + Ghg1 + Ghg2Location + Ghg3.Count + Ghg1.Na + Ghg2Market.Na + Methane.Emissions + Method.Ind + Cdp.Targetamount.Mean + Cdp.Targettype.Absolute + Cdp.Aggregated.Risk +  Cdp.Aggregated.Opp + Initiative.Scope1 + Initiative.Scope2 + Initiative.Scope3 + Absent.Cdp.Initiative.Firm.Year.Processed.Csv + Co2.Counter + Msaving.Counter + Investment.Counter + Investment.Total.Log1P  + (1|Industry/Id) + (1 |Continent/Country), data = data)


summary(model16.3)
model_performance(model16.3)
```

```{r}
model16.4 = lmer(Ghg.Change.Real.Next ~ Year + Ghg.Change.Real + Market.Cap + Revenue +  Type.Scope1 + Ghg.Verification.Scope3.Yes + Ghg1 + Ghg2Location + Ghg3.Count + Ghg1.Na + Ghg2Market.Na + Methane.Emissions + Method.Ind + Cdp.Targetamount.Mean + Cdp.Targettype.Absolute + Cdp.Aggregated.Risk +  Cdp.Aggregated.Opp + Absent.Cdp.Initiative.Firm.Year.Processed.Csv + Investment.Counter + (1|Industry/Id) + (1 |Continent/Country), data = data)


summary(model16.4)
model_performance(model16.4)
```

```{r}
# putting 16.1, 16.2, 16.3, 16.4 into stargazer
class(model16.1) <- "lmerMod"
class(model16.2) <- "lmerMod"
class(model16.3) <- "lmerMod"
class(model16.4) <- "lmerMod"

tidyM1 <- broom::tidy(model16.1) %>% filter(effect == "fixed")
tidyM2 <- broom::tidy(model16.2) %>% filter(effect == "fixed")
tidyM3 <- broom::tidy(model16.3) %>% filter(effect == "fixed")
tidyM4 <- broom::tidy(model16.4) %>% filter(effect == "fixed")

 # Number of unique regions for that one random effect
num_Id <- as.numeric(sapply(ranef(model16.1),nrow)[1])
num_Country <- as.numeric(sapply(ranef(model16.1),nrow)[2])
num_Industry <- as.numeric(sapply(ranef(model16.1),nrow)[3])
num_Continent <- as.numeric(sapply(ranef(model16.1),nrow)[4])

sd_IdM1 <- round(as.numeric(attributes(VarCorr(model16.1)$"Id")$stddev), 3)
sd_IndustryM1 <- round(as.numeric(attributes(VarCorr(model16.1)$"Industry")$stddev), 3)
sd_ContinentM1 <- round(as.numeric(attributes(VarCorr(model16.1)$"Continent")$stddev), 3)
sd_CountryM1 <- round(as.numeric(attributes(VarCorr(model16.1)$"Country")$stddev), 3)

sd_IdM2 <- round(as.numeric(attributes(VarCorr(model16.2)$"Id")$stddev), 3)
sd_IndustryM2 <- round(as.numeric(attributes(VarCorr(model16.2)$"Industry")$stddev), 3)
sd_ContinentM2 <- round(as.numeric(attributes(VarCorr(model16.2)$"Continent")$stddev), 3)
sd_CountryM2 <- round(as.numeric(attributes(VarCorr(model16.2)$"Country")$stddev), 3)

sd_IdM3 <- round(as.numeric(attributes(VarCorr(model16.3)$"Id")$stddev), 3)
sd_IndustryM3 <- round(as.numeric(attributes(VarCorr(model16.3)$"Industry")$stddev), 3)
sd_ContinentM3 <- round(as.numeric(attributes(VarCorr(model16.3)$"Continent")$stddev), 3)
sd_CountryM3 <- round(as.numeric(attributes(VarCorr(model16.3)$"Country")$stddev), 3)

sd_IdM4 <- round(as.numeric(attributes(VarCorr(model16.4)$"Id")$stddev), 3)
sd_IndustryM4 <- round(as.numeric(attributes(VarCorr(model16.4)$"Industry")$stddev), 3)
sd_ContinentM4 <- round(as.numeric(attributes(VarCorr(model16.4)$"Continent")$stddev), 3)
sd_CountryM4 <- round(as.numeric(attributes(VarCorr(model16.4)$"Country")$stddev), 3)



tribble(~stat, ~M1, ~M2, ~M3, ~M4,
        "\\textbf{Random Effects:}", NA, NA, NA, NA,
        "Number of Firms", num_Id, num_Id, num_Id, num_Id,
        "Number of Industries", num_Industry, num_Industry, num_Industry, num_Industry,
        "Number of Continents", num_Continent, num_Continent, num_Continent, num_Continent,
         "Number of Countries", num_Country, num_Country, num_Country, num_Country,
        "sd(Firms:Industry)", sd_IdM1, sd_IdM2, sd_IdM3, sd_IdM4,
        "sd(Industry)", sd_IndustryM1, sd_IndustryM2, sd_IndustryM3, sd_IndustryM4,
        "sd(Continent)", sd_ContinentM1, sd_ContinentM2, sd_ContinentM3, sd_ContinentM4,
        "sd(Country:Continent)", sd_CountryM1, sd_CountryM2, sd_CountryM3, sd_CountryM4,
        "Akaike Inf. Crit.", round(AIC(model16.1), 3), round(AIC(model16.2), 3), round(AIC(model16.3), 3), round(AIC(model16.4), 3),
        "Bayesian Inf. Crit.", round(BIC(model16.1), 3), round(BIC(model16.2), 3), round(BIC(model16.3), 3), round(BIC(model16.4), 3)
        
        ) -> mod_stats


table <- capture.output({
stargazer(model16.1, model16.2, model16.3, model16.4, type="latex", 
          # ^  Notice M2 is called twice. I'm going somewhere with this.
          # Below: manually supply tidied coefficients and standard errors
          coef = list(tidyM1$estimate, tidyM2$estimate, tidyM3$estimate, tidyM4$estimate),
          se = list(tidyM1$std.error, tidyM2$std.error, tidyM3$std.error, tidyM4$std.error),
          omit.table.layout = "s",
          # ...but supply your own that you created (with random effects)
          add.lines = lapply(1:nrow(mod_stats), function(i) unlist(mod_stats[i, ])),
          notes="Seventh Model focuses on GHG, Verification, and Incentives",
          dep.var.labels="Next Year Decarbonization Rate",
          model.names = FALSE, 
          title = "Impact of GHG, Verification, Incentives, Targets, Risks and Opportunities, Initiatives, Investments on Decarbonization",
          single.row = TRUE,
          table.placement = "H",
          label = paste0("tab:", "R8"))})

table <- gsub("\\begin{tabular}","\\resizebox{0.7\\textwidth}{!}{\\begin{tabular}", table,fixed=T)
table <- gsub("\\end{tabular}","\\end{tabular}}", table,fixed=T)
table <- table[-(1:3)]

cat(table, file = "../../thesis_tex/tables/R8.tex")

```


```{r}
# Ghg.Int.Figure.Na + Ghg.Int.Change.Na + Absent.Cdp.Ghg.Int.Processed.Csv + Cdp.Num.Credits.Clean.Count +  # #Cdp.Orig.Or.Purchase.Clean.Credit.Origination + Cdp.Purpose.Clean.Voluntary.Offsetting +   #Absent.Cdp.Carbon.Credits.Full.Processed.Csv

model17.1 = lmer(Ghg.Change.Real.Next ~ Year + Ghg.Change.Real + Market.Cap + Revenue +  Type.Scope1 + Ghg.Verification.Scope3.Yes + Ghg1 + Ghg2Location + Ghg3.Count + Ghg1.Na + Ghg2Market.Na + Methane.Emissions + Method.Ind + Cdp.Targetamount.Mean + Cdp.Targettype.Absolute + Cdp.Aggregated.Risk +  Cdp.Aggregated.Opp + Absent.Cdp.Initiative.Firm.Year.Processed.Csv + Investment.Counter + Ghg.Int.Figure.Na +  Absent.Cdp.Ghg.Int.Processed.Csv + (1|Industry/Id) + (1 |Continent/Country), data = data)


summary(model17.1)
model_performance(model17.1)
```

```{r}
model17.2 = lmer(Ghg.Change.Real.Next ~ Year + Ghg.Change.Real + Market.Cap + Revenue +  Type.Scope1 + Ghg.Verification.Scope3.Yes + Ghg1 + Ghg2Location + Ghg3.Count + Ghg1.Na + Ghg2Market.Na + Methane.Emissions + Method.Ind + Cdp.Targetamount.Mean + Cdp.Targettype.Absolute + Cdp.Aggregated.Risk +  Cdp.Aggregated.Opp + Absent.Cdp.Initiative.Firm.Year.Processed.Csv + Investment.Counter + Cdp.Num.Credits.Clean.Count + Cdp.Orig.Or.Purchase.Clean.Credit.Origination + Cdp.Purpose.Clean.Voluntary.Offsetting +    Absent.Cdp.Carbon.Credits.Full.Processed.Csv + (1|Industry/Id) + (1 |Continent/Country), data = data)


summary(model17.2)
model_performance(model17.2)
```



```{r}
# inserting 17.1 and 17.2 into stargazer

class(model17.1) <- "lmerMod"
class(model17.2) <- "lmerMod"

tidyM1 <- broom::tidy(model17.1) %>% filter(effect == "fixed")
tidyM2 <- broom::tidy(model17.2) %>% filter(effect == "fixed")

 # Number of unique regions for that one random effect
num_Id <- as.numeric(sapply(ranef(model17.1),nrow)[1])
num_Country <- as.numeric(sapply(ranef(model17.1),nrow)[2])
num_Industry <- as.numeric(sapply(ranef(model17.1),nrow)[3])
num_Continent <- as.numeric(sapply(ranef(model17.1),nrow)[4])

sd_IdM1 <- round(as.numeric(attributes(VarCorr(model17.1)$"Id")$stddev), 3)
sd_IndustryM1 <- round(as.numeric(attributes(VarCorr(model17.1)$"Industry")$stddev), 3)
sd_ContinentM1 <- round(as.numeric(attributes(VarCorr(model17.1)$"Continent")$stddev), 3)
sd_CountryM1 <- round(as.numeric(attributes(VarCorr(model17.1)$"Country")$stddev), 3)

sd_IdM2 <- round(as.numeric(attributes(VarCorr(model17.2)$"Id")$stddev), 3)
sd_IndustryM2 <- round(as.numeric(attributes(VarCorr(model17.2)$"Industry")$stddev), 3)
sd_ContinentM2 <- round(as.numeric(attributes(VarCorr(model17.2)$"Continent")$stddev), 3)
sd_CountryM2 <- round(as.numeric(attributes(VarCorr(model17.2)$"Country")$stddev), 3)


tribble(~stat, ~M1, ~M2,
        "\\textbf{Random Effects:}", NA, NA,
        "Number of Firms", num_Id, num_Id,
        "Number of Industries", num_Industry, num_Industry,
        "Number of Continents", num_Continent, num_Continent,
         "Number of Countries", num_Country, num_Country,
        "sd(Firms:Industry)", sd_IdM1, sd_IdM2,
        "sd(Industry)", sd_IndustryM1, sd_IndustryM2,
        "sd(Continent)", sd_ContinentM1, sd_ContinentM2,
        "sd(Country:Continent)", sd_CountryM1, sd_CountryM2,
        "Akaike Inf. Crit.", round(AIC(model17.1), 3), round(AIC(model17.2), 3),
        "Bayesian Inf. Crit.", round(BIC(model17.1), 3), round(BIC(model17.2), 3)
        
        ) -> mod_stats


table <- capture.output({
stargazer(model17.1, model17.2, type="latex", 
          # ^  Notice M2 is called twice. I'm going somewhere with this.
          # Below: manually supply tidied coefficients and standard errors
          coef = list(tidyM1$estimate, tidyM2$estimate),
          se = list(tidyM1$std.error, tidyM2$std.error),
          omit.table.layout = "s",
          # ...but supply your own that you created (with random effects)
          add.lines = lapply(1:nrow(mod_stats), function(i) unlist(mod_stats[i, ])),
          notes="Eighth Model focuses on GHG, Verification, and Incentives",
          dep.var.labels="Next Year Decarbonization Rate",
          model.names = FALSE, 
          title = "Impact of GHG, Verification, Incentives, Targets, Risks and Opportunities, Initiatives, Investments, and Carbon Credits on Decarbonization",
          single.row = TRUE,
          table.placement = "H",
          label = paste0("tab:", "R9"))})

table <- gsub("\\begin{tabular}","\\resizebox{0.7\\textwidth}{!}{\\begin{tabular}", table,fixed=T)
table <- gsub("\\end{tabular}","\\end{tabular}}", table,fixed=T)
table <- table[-(1:3)]

cat(table, file = "../../thesis_tex/tables/R9.tex")

```

```{r}
step_model = lmer(Ghg.Change.Real.Next ~ Year + Ghg.Change.Real + Market.Cap + Revenue +  Type.Scope1 + Ghg.Verification.Scope3.Yes + Ghg1 + Ghg2Location + Ghg3.Count + Ghg1.Na + Ghg2Market.Na + Methane.Emissions + Method.Ind + Cdp.Targetamount.Mean + Cdp.Targettype.Absolute + Cdp.Aggregated.Risk +  Cdp.Aggregated.Opp + Absent.Cdp.Initiative.Firm.Year.Processed.Csv + Investment.Counter + (1|Industry/Id) + (1 |Continent/Country), data = data)

# run backwards step seleciotn on mdoel 16.4
step_model = step(step_model, direction = "backward")

step_model = get_model(step_model)

summary(step_model)
model_performance(step_model)
```

```{r}
data$Ghg.Change.Real.Lag1 = lag(data$Ghg.Change.Real, 1)
```


```{r}

final_model = lmer(Ghg.Change.Real.Next ~ Year + Ghg.Change.Real + Market.Cap + Revenue +  Type.Scope1 + Ghg.Verification.Scope3.Yes + Ghg1 + Ghg2Location + Ghg1.Na + Ghg2Market.Na + Methane.Emissions + Method.Ind + Cdp.Targetamount.Mean + Cdp.Targettype.Absolute + Cdp.Aggregated.Risk +  Cdp.Aggregated.Opp + Absent.Cdp.Initiative.Firm.Year.Processed.Csv + Investment.Counter + (1|Industry/Id) + (1 |Continent/Country), data = data)


summary(final_model)
model_performance(final_model)
```


```{r}
inference = lmer(Ghg.Change.Real ~ Year + Ghg.Change.Real.Lag1 + Market.Cap + Revenue +  Type.Scope1 + Ghg.Verification.Scope3.Yes + Ghg1 + Ghg2Location + Ghg1.Na + Ghg2Market.Na + Methane.Emissions + Method.Ind + Cdp.Targetamount.Mean + Cdp.Targettype.Absolute + Cdp.Aggregated.Risk +  Cdp.Aggregated.Opp + Absent.Cdp.Initiative.Firm.Year.Processed.Csv + Investment.Counter + (1|Industry/Id) + (1 |Continent/Country), data = data)


summary(inference)
model_performance(inference)
```

```{r}
# insert step model and final model into stargazer
class(step_model) <- "lmerMod"
class(final_model) <- "lmerMod"

tidyM1 <- broom::tidy(step_model) %>% filter(effect == "fixed")
tidyM2 <- broom::tidy(final_model) %>% filter(effect == "fixed")

 # Number of unique regions for that one random effect
num_Id <- as.numeric(sapply(ranef(step_model),nrow)[1])
num_Country <- as.numeric(sapply(ranef(step_model),nrow)[2])
num_Industry <- as.numeric(sapply(ranef(step_model),nrow)[3])
num_Continent <- as.numeric(sapply(ranef(final_model),nrow)[4])

sd_IdM1 <- round(as.numeric(attributes(VarCorr(step_model)$"Id")$stddev), 3)
sd_IndustryM1 <- round(as.numeric(attributes(VarCorr(step_model)$"Industry")$stddev), 3)
sd_ContinentM1 <- round(as.numeric(attributes(VarCorr(step_model)$"Continent")$stddev), 3)
sd_CountryM1 <- round(as.numeric(attributes(VarCorr(step_model)$"Country")$stddev), 3)

                      
sd_IdM2 <- round(as.numeric(attributes(VarCorr(final_model)$"Id")$stddev), 3)
sd_IndustryM2 <- round(as.numeric(attributes(VarCorr(final_model)$"Industry")$stddev), 3)
sd_ContinentM2 <- round(as.numeric(attributes(VarCorr(final_model)$"Continent")$stddev), 3)
sd_CountryM2 <- round(as.numeric(attributes(VarCorr(final_model)$"Country")$stddev), 3)



tribble(~stat, ~M1, ~M2,
        "\\textbf{Random Effects:}", NA, NA,
        "Number of Firms", num_Id, num_Id,
        "Number of Industries", num_Industry, num_Industry,
        "Number of Continents", num_Continent, num_Continent,
         "Number of Countries", num_Country, num_Country,
        "sd(Firms:Industry)", sd_IdM1, sd_IdM2,
        "sd(Industry)", sd_IndustryM1, sd_IndustryM2,
        "sd(Continent)", sd_ContinentM1, sd_ContinentM2,
        "sd(Country:Continent)", sd_CountryM1, sd_CountryM2,
        "Akaike Inf. Crit.", round(AIC(step_model), 3), round(AIC(final_model), 3),
        "Bayesian Inf. Crit.", round(BIC(step_model), 3), round(BIC(final_model), 3),
        "R-squared", round(model_performance(step_model)$R2_conditional, 3), round(model_performance(final_model)$R2_conditional, 3)
        
        ) -> mod_stats
        

table <- capture.output({
stargazer(step_model, final_model, type="latex", 
          # ^  Notice M2 is called twice. I'm going somewhere with this.
          # Below: manually supply tidied coefficients and standard errors
          coef = list(tidyM1$estimate, tidyM2$estimate),
          se = list(tidyM1$std.error, tidyM2$std.error),
          omit.table.layout = "s",
          # ...but supply your own that you created (with random effects)
          add.lines = lapply(1:nrow(mod_stats), function(i) unlist(mod_stats[i, ])),
          notes="Ninth Model focuses on GHG, Verification, and Incentives",
          dep.var.labels="Next Year Decarbonization Rate",
          model.names = FALSE, 
          title = "Impact of GHG, Verification, Incentives, Targets, Risks and Opportunities, Initiatives, Investments, and Carbon Credits on Decarbonization",
          single.row = TRUE,
          table.placement = "H",
          label = paste0("tab:", "R10"))})

table <- gsub("\\begin{tabular}","\\resizebox{0.8\\textwidth}{!}{\\begin{tabular}", table,fixed=T)
table <- gsub("\\end{tabular}","\\end{tabular}}", table,fixed=T)
table <- table[-(1:3)]

cat(table, file = "../../thesis_tex/tables/R10.tex")
```


```{r}
# ok now for every model store the AIC in a vector and plot it
aic = c(model_performance(model1)$AIC, model_performance(model2)$AIC, model_performance(model3)$AIC, model_performance(model4)$AIC, model_performance(model6)$AIC, model_performance(model7)$AIC, model_performance(model8)$AIC, model_performance(model9)$AIC, model_performance(model10)$AIC, model_performance(model13.1)$AIC, model_performance(model14.1)$AIC, model_performance(model14.2)$AIC, model_performance(model14.3)$AIC, model_performance(model14.4)$AIC, model_performance(model15.1)$AIC, model_performance(model15.2)$AIC, model_performance(model15.3)$AIC, model_performance(model15.4)$AIC, model_performance(model16.1)$AIC, model_performance(model16.2)$AIC, model_performance(model16.3)$AIC, model_performance(model16.4)$AIC, model_performance(model17.1)$AIC, model_performance(model17.2)$AIC, model_performance(step_model)$AIC, model_performance(final_model)$AIC)

```





```{r}
png("aic.png", width = 2400, height = 1600, res = 300)
plot(aic, main = "AIC for each tested model", xlab = "Model #", ylab = "AIC", type = "l", col = "blue")
#save the plot to a file
dev.off()
```


